@page "/employees"
<div class="header">
    <h3>Pracownicy</h3>
</div>
    
<div>
    @if (Login.UserLoggedIn.If_manager == 2)
    {
        <div class="actionBtn">
            <Sfbutton class="btn btn-primary" @onclick="AddEmployee">Nowy pracownik</Sfbutton>
        </div>
        <div class="actionBtn">
            <Sfbutton class="btn btn-primary" @onclick="EditEmployee">Edytuj</Sfbutton>
        </div>
    }
</div>
        <div class="form-group">
            <SfToast @ref="NoSelectedEmployee" Title="Wybierz pracownika!" Timeout=2000>
                <ToastPosition X="Center"></ToastPosition>
            </SfToast>
        </div>
        <SfDialog @bind-Visible="@VisibilityEdit" AllowDragging="true" Width="500px" IsModal="true" ShowCloseIcon="true">
            <DialogTemplates>
                <Header>
                    Edycja uprawnień
                </Header>
                <Content>
                    <div class="form-group">
                        <label for="Imie" class="employeelabel">@SelectedEmployee.First_name</label>
                        <label for="Nazwisko" class="employeelabel">@SelectedEmployee.Last_name</label>
                    </div>
                    <EditForm Model="@EmployeeEdit">
                        <DataAnnotationsValidator />
                        <div class="col-lg-12 control-section multiselect-height">
                            <div class="control-wrapper multi-select-parent">
                                <div class="padding-top">
                                    <label asp-for="Rola" class="control-label">Rola</label>
                                    <SfMultiSelect TValue="string" TItem="string"
                                                   @bind-Value="@EmployeeEdit.role"
                                                   Placeholder="Szukaj..."
                                                   Enabled=@Enabled
                                                   DataSource="@rola" AllowFiltering="true"
                                                   MaximumSelectionLength=1>
                                        <MultiSelectFieldSettings Text="status"> </MultiSelectFieldSettings>
                                    </SfMultiSelect>
                                    <ValidationMessage For="@(() => EmployeeEdit.role)" />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 control-section multiselect-height">
                            <div class="control-wrapper multi-select-parent">
                                <div class="padding-top">
                                    <label asp-for="etykiety" class="control-label">Etykiety</label>
                                    <SfMultiSelect TValue="string[]" TItem="BackendLibrary.Models.LabelModel"
                                                   @bind-Value="@nameoflabels"
                                                   Enabled=@Enabled
                                                   Placeholder="Szukaj..."
                                                   DataSource="@labelsInDb" AllowFiltering="true" AllowCustomValue="true"
                                                   Mode="@VisualMode.Box">
                                        <MultiSelectFieldSettings Text="Name">  </MultiSelectFieldSettings>
                                    </SfMultiSelect>
                                    <ValidationMessage For="@(() => EmployeeEdit.SelectedLabel)" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12 control-section multiselect-height">
                            <div class="control-wrapper multi-select-parent">
                                <div class="padding-top">
                                    <label asp-for="projekt" class="control-label">Projekt</label>
                                    <SfMultiSelect TValue="string[]" TItem="BackendLibrary.Models.ProjectModel"
                                                   @bind-Value="@nameofProjects"
                                                   Enabled=@Enabled
                                                   Placeholder="Szukaj..."
                                                   DataSource="@projectsInDb" AllowFiltering="true"
                                                   Mode="@VisualMode.Box">
                                        <MultiSelectFieldSettings Text="Name"></MultiSelectFieldSettings>
                                    </SfMultiSelect>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-block btn-info" data-dismiss="modal" hidden=@readOnly>Zapisz</button>
                            <SfToast @ref="ToastObj" Title="Dane zaktualizowane pomyslnie!" Timeout=3000 Content="@ToastContentEdit">
                                <ToastPosition X="Right"></ToastPosition>
                            </SfToast>
                            <SfToast @ref="FailedObj" Title="Brak zmian!" Timeout=3000 Content="@FailedContent">
                                <ToastPosition X="Right"></ToastPosition>
                            </SfToast>
                        </div>
                    </EditForm>
                </Content>
            </DialogTemplates>
            <DialogEvents Closed="@DialogEditClosed"></DialogEvents>
            <DialogAnimationSettings Effect="DialogEffect.Fade"></DialogAnimationSettings>
        </SfDialog>
        <SfDialog @bind-Visible="@visibility" IsModal="true" Target="#target" Width="500px" ShowCloseIcon="true">
            <DialogEvents></DialogEvents>
            <DialogAnimationSettings Effect="DialogEffect.Zoom"></DialogAnimationSettings>
            <DialogTemplates>
                <Header>
                    Dodawanie nowego pracownika
                </Header>
                <Content>
                    <p>Wprowadź adres e-mail przypisany do pracownika, którego chcesz dodać.</p>
                    <input type="email" @bind-value="@inputValue" name="Required" class="e-input" style="width: 415px;">
                    <label style="color: indianred">@errorMessage</label>
                </Content>
            </DialogTemplates>
            <DialogButtons>
                <DialogButton Content="Dodaj" IsPrimary="true" OnClick="@submitAdd" />
            </DialogButtons>
        </SfDialog>

        <br />
        <br />
    

    <SfGrid DataSource="EmployeeList"
            AllowPaging="true"
            AllowSorting="true"
            AllowFiltering="false"
            ContextMenuItems="@(new List<object>()
            { "AutoFit", "AutoFitAll", "SortAscending", "SortDescending", "Copy"})">
        <GridPageSettings PageSize="12"></GridPageSettings>
        <GridEvents TValue="EmployeeModel"
            OnRecordDoubleClick="DisplayEmployeeDetails" >
        </GridEvents>
        <GridColumns>
            <GridColumn Field=@nameof(EmployeeModel.Employee_id) IsPrimaryKey="true" HeaderText="ID" TextAlign="TextAlign.Left" Width="50"></GridColumn>
            <GridColumn Field=@nameof(EmployeeModel.First_name) HeaderText="Imię" TextAlign="TextAlign.Left" Width="80"></GridColumn>
            <GridColumn Field=@nameof(EmployeeModel.Last_name) HeaderText="Nazwisko" TextAlign="TextAlign.Left" Width="120"></GridColumn>
            <GridColumn Field=@nameof(EmployeeModel.Email) HeaderText="E-mail" TextAlign="TextAlign.Left" Width="120"></GridColumn>
            <GridColumn Field=@nameof(EmployeeModel.UserType) HeaderText="Rodzaj" TextAlign="TextAlign.Left" Width="80"></GridColumn>
        </GridColumns>
    </SfGrid>


@code {
    /// <summary>
    /// Strona wyświetlająca listę pracowników.
    /// </summary>
    SfToast NoSelectedEmployee;

    public static List<EmployeeModel> EmployeeList;
    public static EmployeeModel SelectedEmployee;
    public int length;
    private EditEmployeeValidation Employee;
    private Boolean visibility { get; set; }
    string inputValue, errorMessage;
    private bool readOnly = false;
    private bool Enabled = true;
    private SfGrid<EmployeeModel> DefaultGrid;
    private string searchStr;

    private List<String> rola = new List<String>(new string[] { "Pracownik", "Kierownik", "Szef" });
    SfToast ToastObj;
    SfToast FailedObj;
    private string ToastContentEdit { get; set; } = "Dane zaktualizowane pomyslnie!";
    private string FailedContent { get; set; } = "Brak zmian!";
    private BackendLibrary.Validation.EditEmployeeValidation EmployeeEdit;
    DateTime defaultDate = new DateTime(0001, 1, 1, 0, 0, 0);
    private Boolean VisibilityEdit { get; set; }
    private string[] nameoflabels { get; set; } = new string[] { };
    private string[] oldlabels { get; set; } = new string[] { };
    private string[] nameofProjects { get; set; } = new string[] { };
    private string[] oldProjects { get; set; } = new string[] { };
    public static List<BackendLibrary.Models.EmployeeModel> ListOfEmployee;
    public static List<BackendLibrary.Models.EmployeeTaskModel> ListofEmployeesId;
    private int[] nameofEmployees { get; set; } = new int[] { };
    public static List<BackendLibrary.Models.EmployeeLabelModel> ListofLabelsId;
    public static List<BackendLibrary.Models.EmployeeProjectModel> ListofProjectsId;
    private bool isChecked = false;
    public bool EnableProjectDropDown = false;
    //public static List<BackendLibrary.Models.TaskLabelModel> ListofLabelsId;

    private List<BackendLibrary.Models.LabelModel> labelsInDb;
    private List<BackendLibrary.Models.ProjectModel> projectsInDb;
    private string[] selectedLabels { get; set; } = new string[] { };
    private string selectedProject;
    private int lastTaskId;
    private int labelIdByName;
    private string mergedSelectedLabels;
    private bool isMergedLabelsMatchToPattern;
    private string pattern = @"^[a-zA-Z0-9]+$";
    private Boolean VisibilityAdd { get; set; }

    protected override void OnInitialized()
    {
        if (Login.UserLoggedIn.If_manager == -1)
        {
            NavigationManager.NavigateTo("/");
        }
        if (Login.UserLoggedIn.If_manager == 0)
        {
            readOnly = true;
            Enabled = false;
        }

        SelectedEmployee = new EmployeeModel();
        EmployeeList = EmployeeData.GetAllByCompanyId(Login.UserLoggedIn.Company_id);
        EmployeeEdit = new BackendLibrary.Validation.EditEmployeeValidation();
        labelsInDb = BackendLibrary.DataAccess.LabelData.GetAllByCompanyId(Login.UserLoggedIn.Company_id);
        projectsInDb = BackendLibrary.DataAccess.ProjectData.GetAllByCompanyId(Login.UserLoggedIn.Company_id);
        length = EmployeeList.Count;
        inputValue = "";
        errorMessage = "";
        visibility = false;
    }

    private void AddEmployee()
    {
        visibility = true;

    }

    private void EditEmployee()
    {
        if (SelectedEmployee != null)
        {
            EmployeeEdit.firstname = SelectedEmployee.First_name;
            EmployeeEdit.lastname = SelectedEmployee.Last_name;
            EmployeeEdit.email = SelectedEmployee.Email;
            EmployeeEdit.role = SelectedEmployee.UserType;
            VisibilityEdit = true;
        }
        else
        {
            NoSelectedEmployee.Show();
        }
    }

    public void RowSelectHandler(RowSelectEventArgs<EmployeeModel> args)
    {
        SelectedEmployee = args.Data;
    }

    public void RowDeselectHandler()
    {
        SelectedEmployee = null;
    }

    private void DialogEditClosed(CloseEventArgs args)
    {
        VisibilityEdit = false;

    }

    private void DisplayEmployeeDetails(RecordDoubleClickEventArgs<EmployeeModel> args)
    {
        SelectedEmployee = args.RowData;

        if (SelectedEmployee != null)
        {
            ListOfEmployee = EmployeeData.GetByIdList(Pages.Employees.SelectedEmployee.Employee_id); //jednoelementowa lista zawierająca wybranego pracownika


            //tutaj przechowywane są id etykiet, nastepnie odpowiednie etykiety wpisane do tablicy
            ListofLabelsId = EmployeeLabelData.GetAllLabelsByEmployeeId(Pages.Employees.SelectedEmployee.Employee_id);
            this.nameoflabels = new string[ListofLabelsId.Count];
            this.oldlabels = new string[ListofLabelsId.Count];

            /* ListofProjectsId = EmployeeProjectData.GetAllProjectsByEmployeeId(Pages.Employees.SelectedEmployee.Employee_id);
            this.nameofProjects = new string[ListofProjectsId.Count];
            this.oldProjects = new string[ListofProjectsId.Count]; */

            for (int i = 0; i < ListofLabelsId.Count; i++)
            {
                nameoflabels[i] = LabelData.GetById(ListofLabelsId[i].Label_id).Name;
                oldlabels[i] = LabelData.GetById(ListofLabelsId[i].Label_id).Name;
            }

            /* for (int i = 0; i < ListofProjectsId.Count; i++)
            {
                nameofProjects[i] = LabelData.GetById(ListofProjectsId[i].Project_id).Name;
                oldProjects[i] = LabelData.GetById(ListofProjectsId[i].Project_id).Name;
            } */


        }



        if (SelectedEmployee != null)
        {
            EmployeeEdit.role = SelectedEmployee.UserType;
            EmployeeEdit.firstname = SelectedEmployee.First_name;
            EmployeeEdit.lastname = SelectedEmployee.Last_name;
            EmployeeEdit.email = SelectedEmployee.Email;
            EmployeeEdit.login = SelectedEmployee.Login;
            EmployeeEdit.password = SelectedEmployee.Password;


            VisibilityEdit = true;
        }
        else
        {
            NoSelectedEmployee.Show();
        }


    }

    private void EmployeeDetails(MouseEventArgs e)
    {

    }

    /// <summary>
    /// Próba dodania do firmy pracownika o przekazanym adresie e-mail.
    /// </summary>
    private void submitAdd()
    {
        Boolean success = false;

        int employeeId = EmployeeData.GetIdByEmail(inputValue);

        if (employeeId > 0)
        {
            success = EmployeeData.SetCompanyForEmployee(employeeId, Login.UserLoggedIn.Company_id);
        }

        if (success)
        {
            visibility = false;
            errorMessage = "";
            inputValue = "";
        }
        else
        {
            errorMessage = "\nNiepoprawny adres.";
            inputValue = "";
        }
    }

    private void overlayClick(MouseEventArgs args)
    {
        visibility = false;
        errorMessage = "";
        inputValue = "";
    }

    private void closeDialog()
    {
        errorMessage = "";
        inputValue = "";
    }
}